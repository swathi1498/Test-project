---
- hosts: tomcatservers
  become: yes
  gather_facts: false

  vars:
    war_name: VProfile.war

  tasks:
  - name: Install Java 1.8 (OpenJDK 8) on Ubuntu
    apt:
      name: openjdk-8-jdk
      state: present
      update_cache: yes

  - name: Install Tomcat
    apt:
      name:
        - tomcat10
        - tomcat10-admin
        - tomcat10-docs
        - tomcat10-common
      state: latest
      update_cache: yes
    tags: [package]

  - name: Install required Python packages
    apt:
      name:
        - python3
        - python3-venv
      state: present

  - name: Create a Python virtual environment
    command: python3 -m venv /opt/pyenv
    args:
      creates: /opt/pyenv

  - name: Upgrade pip in virtualenv
    command: /opt/pyenv/bin/pip install --upgrade pip
    register: pip_upgrade

  - name: Install PyMySQL inside virtualenv
    pip:
      name: PyMySQL
      virtualenv: /opt/pyenv

  - name: Confirm PyMySQL installation
    command: /opt/pyenv/bin/python -c "import pymysql; print('PyMySQL installed successfully')"
    register: pymysql_check
    changed_when: false

  - name: Show PyMySQL install result
    debug:
      var: pymysql_check.stdout

  - name: Download VProfile WAR file
    get_url:
      url: "http://{{ nexusip }}:8081/repository/VProfile-repo/Dev/{{ time }}/{{ build }}/{{ vprofile_version }}"
      dest: "/tmp/{{ war_name }}"
      mode: '0755'

  - name: Stop Tomcat
    service:
      name: tomcat10
      state: stopped

  - name: Remove existing VProfile deployment (if any)
    file:
      path: "/var/lib/tomcat10/webapps/VProfile"
      state: absent

  - name: Remove existing VProfile.war (if any)
    file:
      path: "/var/lib/tomcat10/webapps/VProfile.war"
      state: absent

  - name: Copy WAR to Tomcat webapps directory
    copy:
      src: "/tmp/{{ war_name }}"
      dest: "/var/lib/tomcat10/webapps/{{ war_name }}"
      mode: '0644'

  - name: Start Tomcat
    service:
      name: tomcat10
      state: started

  - name: Wait for WAR to be extracted into VProfile folder
    wait_for:
      path: "/var/lib/tomcat10/webapps/VProfile"
      state: directory
      timeout: 300
